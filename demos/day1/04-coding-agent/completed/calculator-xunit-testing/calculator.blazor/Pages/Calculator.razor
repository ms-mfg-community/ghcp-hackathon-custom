@page "/calculator"
@inject CalculatorService CalculatorService
@implements IDisposable

<PageTitle>Calculator</PageTitle>

<div class="calculator-layout">
    <div class="calculator-wrapper">
        <div class="calculator">
            <div class="calculator-display" data-testid="calculator-display">
                <div class="display-expression">@DisplayExpression</div>
                <div class="display-value" data-testid="display-value">@DisplayValue</div>
            </div>

            <div class="calculator-keypad">
                <button class="key key-clear" @onclick="Clear" data-testid="clear-button">C</button>
                <button class="key key-operator" @onclick='() => HandleOperator("%")'
                    data-testid="modulo-button">%</button>
                <button class="key key-operator" @onclick='() => HandleOperator("^")'
                    data-testid="exponent-button">^</button>
                <button class="key key-operator" @onclick='() => HandleOperator("/")'
                    data-testid="divide-button">/</button>

                <button class="key key-number" @onclick='() => HandleNumber("7")' data-testid="number-7">7</button>
                <button class="key key-number" @onclick='() => HandleNumber("8")' data-testid="number-8">8</button>
                <button class="key key-number" @onclick='() => HandleNumber("9")' data-testid="number-9">9</button>
                <button class="key key-operator" @onclick='() => HandleOperator("*")'
                    data-testid="multiply-button">×</button>

                <button class="key key-number" @onclick='() => HandleNumber("4")' data-testid="number-4">4</button>
                <button class="key key-number" @onclick='() => HandleNumber("5")' data-testid="number-5">5</button>
                <button class="key key-number" @onclick='() => HandleNumber("6")' data-testid="number-6">6</button>
                <button class="key key-operator" @onclick='() => HandleOperator("-")'
                    data-testid="subtract-button">−</button>

                <button class="key key-number" @onclick='() => HandleNumber("1")' data-testid="number-1">1</button>
                <button class="key key-number" @onclick='() => HandleNumber("2")' data-testid="number-2">2</button>
                <button class="key key-number" @onclick='() => HandleNumber("3")' data-testid="number-3">3</button>
                <button class="key key-operator" @onclick='() => HandleOperator("+")'
                    data-testid="add-button">+</button>

                <button class="key key-number key-zero" @onclick='() => HandleNumber("0")'
                    data-testid="number-0">0</button>
                <button class="key key-number" @onclick="HandleDecimal" data-testid="decimal-button">.</button>
                <button class="key key-equals" @onclick="HandleCalculate" data-testid="calculate-button">=</button>
            </div>
        </div>

        <div class="history-panel">
            <div class="history-header">
                <h3><span class="bi bi-clock-history"></span> History</h3>
                <button class="btn btn-sm btn-outline-secondary" @onclick="ClearHistory"
                    data-testid="clear-history-button">
                    Clear All
                </button>
            </div>
            <div class="history-list" data-testid="history-list">
                @if (History.Count == 0)
                {
                    <div class="history-empty">No calculations yet</div>
                }
                else
                {
                    @foreach (var entry in History.AsEnumerable().Reverse())
                    {
                        <div class="history-item @(entry.IsError ? "history-error" : "")"
                            @onclick="() => LoadFromHistory(entry)" data-testid="history-item">
                            <div class="history-expression">@entry.Expression</div>
                            <div class="history-result">@entry.Result</div>
                            <div class="history-timestamp">@entry.Timestamp.ToString("HH:mm:ss")</div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    private string DisplayValue { get; set; } = "0";
    private string DisplayExpression { get; set; } = "";
    private double FirstNumber { get; set; }
    private double SecondNumber { get; set; }
    private string SelectedOperator { get; set; } = "";
    private bool IsNewNumber { get; set; } = true;
    private bool IsError { get; set; }
    private List<HistoryEntry> History { get; set; } = new();

    public class HistoryEntry
    {
        public string Expression { get; set; } = "";
        public string Result { get; set; } = "";
        public DateTime Timestamp { get; set; }
        public bool IsError { get; set; }
        public double FirstNumber { get; set; }
        public double SecondNumber { get; set; }
        public string Operator { get; set; } = "";
    }

    private void HandleNumber(string number)
    {
        if (IsError)
        {
            Clear();
        }

        if (IsNewNumber)
        {
            DisplayValue = number;
            IsNewNumber = false;
        }
        else
        {
            if (DisplayValue == "0")
            {
                DisplayValue = number;
            }
            else
            {
                DisplayValue += number;
            }
        }
    }

    private void HandleDecimal()
    {
        if (IsError)
        {
            Clear();
        }

        if (IsNewNumber)
        {
            DisplayValue = "0.";
            IsNewNumber = false;
        }
        else if (!DisplayValue.Contains("."))
        {
            DisplayValue += ".";
        }
    }

    private void HandleOperator(string op)
    {
        if (IsError)
        {
            Clear();
        }

        if (!string.IsNullOrEmpty(SelectedOperator) && !IsNewNumber)
        {
            HandleCalculate();
        }

        if (double.TryParse(DisplayValue, out double value))
        {
            FirstNumber = value;
            SelectedOperator = op;
            DisplayExpression = $"{FirstNumber} {GetOperatorSymbol(op)}";
            IsNewNumber = true;
        }
    }

    private void HandleCalculate()
    {
        if (string.IsNullOrEmpty(SelectedOperator) || IsNewNumber)
        {
            return;
        }

        if (!double.TryParse(DisplayValue, out double value))
        {
            DisplayValue = "Error";
            IsError = true;
            return;
        }

        SecondNumber = value;
        var result = CalculatorService.Calculate(FirstNumber, SecondNumber, SelectedOperator);

        string expression = $"{FirstNumber} {GetOperatorSymbol(SelectedOperator)} {SecondNumber}";
        string resultText;

        if (result.Success)
        {
            resultText = result.Value.ToString();
            DisplayValue = resultText;
            DisplayExpression = $"{expression} =";
            IsError = false;

            History.Add(new HistoryEntry
            {
                Expression = expression,
                Result = resultText,
                Timestamp = DateTime.Now,
                IsError = false,
                FirstNumber = FirstNumber,
                SecondNumber = SecondNumber,
                Operator = SelectedOperator
            });

            FirstNumber = result.Value;
        }
        else
        {
            resultText = result.ErrorMessage ?? "Error";
            DisplayValue = "Error";
            DisplayExpression = expression;
            IsError = true;

            History.Add(new HistoryEntry
            {
                Expression = expression,
                Result = resultText,
                Timestamp = DateTime.Now,
                IsError = true,
                FirstNumber = FirstNumber,
                SecondNumber = SecondNumber,
                Operator = SelectedOperator
            });
        }

        SelectedOperator = "";
        IsNewNumber = true;
    }

    private void Clear()
    {
        DisplayValue = "0";
        DisplayExpression = "";
        FirstNumber = 0;
        SecondNumber = 0;
        SelectedOperator = "";
        IsNewNumber = true;
        IsError = false;
    }

    private void ClearHistory()
    {
        History.Clear();
    }

    private void LoadFromHistory(HistoryEntry entry)
    {
        if (!entry.IsError)
        {
            Clear();
            FirstNumber = entry.FirstNumber;
            SecondNumber = entry.SecondNumber;
            SelectedOperator = entry.Operator;
            DisplayExpression = $"{FirstNumber} {GetOperatorSymbol(SelectedOperator)} {SecondNumber} =";
            DisplayValue = entry.Result;
        }
    }

    private string GetOperatorSymbol(string op)
    {
        return op switch
        {
            "+" => "+",
            "-" => "−",
            "*" => "×",
            "/" => "/",
            "%" => "%",
            "^" => "^",
            _ => op
        };
    }

    public void Dispose()
    {
        // Cleanup if needed
    }
}